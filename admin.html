<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - KSJI Cadet Portal</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="logo-section">
                <a href="index.html" style="text-decoration: none; display: flex; align-items: center; gap: 1rem;">
                    <img src="images/logo.png" alt="KSJi Logo" class="logo">
                    <span class="site-name">KSJI Cadet Portal</span>
                </a>
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="handleLogout()">Exit Admin</button>
            </div>
        </div>
    </nav>

    <main class="dashboard-container">
        <div class="dashboard-header">
            <h1>Admin Dashboard</h1>
            <p id="adminWelcome">Manage members and track dues payments</p>
        </div>

        <!-- Added dedicated section for marking dues payments with clear UX -->
        <div class="dashboard-card">
            <h3>Mark Dues as Paid</h3>
            <div class="dues-marking-section">
                <div class="form-group">
                    <label for="duesMemberSelect">Select Member:</label>
                    <select id="duesMemberSelect" class="search-box">
                        <option value="">Choose a member...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="duesMonthSelect">Select Month:</label>
                    <select id="duesMonthSelect" class="search-box">
                        <option value="">Choose a month...</option>
                        <option value="1-2025">January 2025</option>
                        <option value="2-2025">February 2025</option>
                        <option value="3-2025">March 2025</option>
                        <option value="4-2025">April 2025</option>
                        <option value="5-2025">May 2025</option>
                        <option value="6-2025">June 2025</option>
                        <option value="7-2025">July 2025</option>
                        <option value="8-2025">August 2025</option>
                        <option value="9-2025">September 2025</option>
                        <option value="10-2025">October 2025</option>
                        <option value="11-2025">November 2025</option>
                        <option value="12-2025">December 2025</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="markSelectedMemberPaid()">Mark as Paid</button>
            </div>
        </div>

        <div class="admin-controls">
            <div class="search-section">
                <input type="text" id="searchInput" placeholder="Search by member name or ID..." class="search-box">
                <button class="btn btn-secondary" onclick="performSearch()">Search</button>
            </div>
        </div>

        <div class="admin-stats">
            <div class="stat-card">
                <h4>Total Members</h4>
                <p id="totalMembers" class="stat-number">0</p>
            </div>
            <div class="stat-card">
                <h4>Total Dues Collected</h4>
                <p id="totalDues" class="stat-number">0</p>
            </div>
        </div>

        <div class="dashboard-card full-width">
            <h3>Member Management</h3>
            <div class="table-container">
                <table class="members-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Cadet ID</th>
                            <th>Email</th>
                            <th>Months Paid</th>
                            <th>Paid Months</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem;">Loading members...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-card full-width">
            <h3>Quick Actions</h3>
            <div class="actions-container">
                <button class="btn btn-secondary" onclick="exportToCSV()">Export Dues Records</button>
                <button class="btn btn-secondary" onclick="toggleDarkMode()">Toggle Dark Mode</button>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 KSJI Cadet Group. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/auth.js"></script>
    <script>
        let allMembers = [];

        document.addEventListener('DOMContentLoaded', function() {
            const user = getLoggedInUser();
            if (!user || !user.isAdminSession) {
                window.location.href = 'index.html';
                return;
            }

            loadMembers();
            updateStats();
            populateMemberSelect();
        });

        function loadMembers(searchTerm = '') {
            const users = getUsersFromStorage();
            allMembers = users.filter(u => u.role === 'member');
            
            let filteredMembers = allMembers;
            if (searchTerm) {
                filteredMembers = allMembers.filter(m => 
                    m.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    m.id.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            const tableBody = document.getElementById('membersTableBody');
            if (filteredMembers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No members found</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            filteredMembers.forEach(member => {
                const row = document.createElement('tr');
                const paidMonths = member.duesPaid && member.duesPaid.length > 0 
                    ? member.duesPaid.map(m => m.split('-')[0]).join(', ')
                    : 'None';
                
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>${member.id}</td>
                    <td>${member.email}</td>
                    <td>${member.duesPaid ? member.duesPaid.length : 0}</td>
                    <td style="font-size: 0.9rem; color: var(--secondary-color);">Month(s): ${paidMonths}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteMember('${member.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value;
            loadMembers(searchTerm);
        }

        function deleteMember(memberId) {
            if (confirm('Are you sure you want to delete this member? This action cannot be undone.')) {
                const users = getUsersFromStorage();
                const filteredUsers = users.filter(u => u.id !== memberId);
                saveUsersToStorage(filteredUsers);
                loadMembers();
                updateStats();
                populateMemberSelect();
            }
        }

        function updateStats() {
            const users = getUsersFromStorage();
            const members = users.filter(u => u.role === 'member');
            const totalDuesPayments = members.reduce((sum, m) => sum + (m.duesPaid ? m.duesPaid.length : 0), 0);

            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('totalDues').textContent = totalDuesPayments + ' months';
        }

        function exportToCSV() {
            const users = getUsersFromStorage();
            const members = users.filter(u => u.role === 'member');

            let csvContent = 'data:text/csv;charset=utf-8,';
            csvContent += 'Name,Cadet ID,Email,Months Paid,Paid Months\n';

            members.forEach(member => {
                const paidMonths = member.duesPaid && member.duesPaid.length > 0 
                    ? member.duesPaid.join('; ')
                    : 'None';
                csvContent += `"${member.name}","${member.id}","${member.email}",${member.duesPaid ? member.duesPaid.length : 0},"${paidMonths}"\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `ksji_dues_records_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        function handleLogout() {
            logoutUser();
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        function populateMemberSelect() {
            const users = getUsersFromStorage();
            const members = users.filter(u => u.role === 'member');
            const memberSelect = document.getElementById('duesMemberSelect');
            
            memberSelect.innerHTML = '<option value="">Choose a member...</option>';
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (${member.id})`;
                memberSelect.appendChild(option);
            });
        }

        function markSelectedMemberPaid() {
            const memberId = document.getElementById('duesMemberSelect').value;
            const selectedMonth = document.getElementById('duesMonthSelect').value;
            
            console.log('[v0] Mark Paid clicked - Member:', memberId, 'Month:', selectedMonth);
            
            if (!memberId) {
                alert('Please select a member');
                return;
            }
            
            if (!selectedMonth) {
                alert('Please select a month');
                return;
            }

            const result = updateMemberDuesPaid(memberId, selectedMonth);
            console.log('[v0] Update result:', result);
            
            if (result.success) {
                const memberName = result.user.name;
                const monthName = document.querySelector(`option[value="${selectedMonth}"]`).textContent;
                alert(`âœ“ Dues marked as paid for ${memberName} - ${monthName}`);
                loadMembers();
                updateStats();
                populateMemberSelect();
                document.getElementById('duesMemberSelect').value = '';
                document.getElementById('duesMonthSelect').value = '';
            } else {
                alert('Error: ' + result.message);
            }
        }
    </script>
</body>
</html>
