<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - KSJI Cadet Portal</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Admin-only inline CSS (light / "kinda white" palette) -->
    <style>
        /* Light admin palette (unchanged) */
        :root {
            --admin-bg-1: linear-gradient(180deg, #ffffff 0%, #f7f9fb 100%);
            --admin-card: #ffffff;
            --admin-accent: #94e646;
            --admin-accent-2: #6c5ce7;
            --admin-text: #0b1b2b;
            --admin-muted: #6b7280;
            --danger: #ef4444;
            --muted-border: #d2dce9;
            --soft-shadow: 0 6px 18px rgba(16,24,40,0.06);
        }

        /* Dark mode variables */
        .dark-mode {
            --admin-bg-1: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%);
            --admin-card: #2d3748;
            --admin-accent: #94e646;
            --admin-accent-2: #6c5ce7;
            --admin-text: #f7fafc;
            --admin-muted: #a0aec0;
            --danger: #fc8181;
            --muted-border: #4a5568;
            --soft-shadow: 0 6px 18px rgba(0,0,0,0.2);
        }

        /* Prevent any horizontal overflow from breaking header/footer */
        html, body { 
            box-sizing: border-box; 
            overflow-x: hidden; 
            margin: 0;
            padding: 0;
        }

        /* Page background */
        body {
            background: var(--admin-bg-1);
            color: var(--admin-text);
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            transition: background-color 220ms ease, color 220ms ease;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navbar (light) - responsive */
        .navbar {
            background: var(--admin-card);
            border-bottom: 1px solid var(--muted-border);
            box-shadow: var(--soft-shadow);
            padding: 0.6rem 1rem;
            width: 100%;
            position: relative;
            z-index: 50;
        }

        .navbar-container {
            max-width: 1120px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            width: 100%;
            box-sizing: border-box;
        }

        /* ensure images can't overflow the header */
        .logo, .logo img { 
            max-width: 100%; 
            height: auto; 
            display: block; 
        }

        .logo-section {
            display:flex;
            align-items:center;
            gap:0.75rem;
            min-width: 0;
            flex: 1 1 auto;
            align-self: center;
        }

        /* limit logo and allow site-name to shrink */
        .logo {
            height: 40px;
            width: auto;
            max-width: 160px;
            flex: 0 0 auto;
        }

        .site-name {
            color: var(--admin-text);
            font-weight: 700;
            letter-spacing: 0.2px;
            font-size: 1.05rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1 1 auto;
            min-width: 0; /* allows truncation instead of overflow */
        }

        /* menu toggle (mobile) */
        .menu-toggle {
            display: none;
            background: transparent;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.35rem;
            margin-left: 0.25rem;
            color: var(--admin-text);
        }

        .nav-buttons {
            display:flex;
            gap:0.6rem;
            align-items:center;
            flex: 0 0 auto;
            justify-content: flex-end;
        }

        .nav-buttons .btn {
            padding: 0.45rem 0.9rem;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        /* Main content area */
        main {
            flex: 1;
            width: 100%;
        }

        /* Dashboard container */
        .dashboard-container {
            max-width: 1120px;
            margin: 1.6rem auto;
            padding: 1.4rem;
            gap: 1rem;
            box-sizing: border-box;
            width: 100%;
        }

        .dashboard-header h1 {
            margin: 0 0 0.2rem 0;
            color: var(--admin-text);
            font-size: 1.6rem;
        }
        .dashboard-header p {
            margin: 0 0 1rem 0;
            color: var(--admin-muted);
        }

        /* Cards (light) */
        .dashboard-card {
            background: var(--admin-card);
            border: 1px solid var(--muted-border);
            padding: 1.2rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            box-shadow: var(--soft-shadow);
        }
        .dashboard-card.full-width { width: 100%; }

        /* Stats */
        .admin-stats {
            display: flex;
            gap: 1rem;
            margin: 0.6rem 0 1rem;
            flex-wrap: wrap;
        }
        .stat-card {
            flex: 1 1 180px;
            padding: 0.8rem;
            border-radius: 8px;
            background: var(--admin-card);
            border: 1px solid var(--muted-border);
            text-align: center;
        }
        .stat-number {
            font-size: 1.4rem;
            color: var(--admin-accent);
            margin: 0.4rem 0 0;
            font-weight: 700;
        }

        /* Table */
        .table-container {
            overflow: auto;
            width: 100%;
        }
        .members-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 720px;
            color: var(--admin-text);
            background: transparent;
        }
        .members-table thead th {
            text-align: left;
            padding: 0.8rem 0.6rem;
            font-size: 0.9rem;
            color: var(--admin-text);
            border-bottom: 1px solid var(--muted-border);
            background: transparent;
        }
        .members-table tbody td {
            padding: 0.85rem 0.6rem;
            border-bottom: 1px solid var(--muted-border);
            vertical-align: middle;
            font-size: 0.95rem;
        }
        .members-table tbody tr:hover {
            background: rgba(11,110,246,0.04);
        }

        /* Buttons (light) */
        .btn {
            border: 1px solid var(--muted-border);
            background: var(--admin-card);
            color: var(--admin-text);
            padding: 0.45rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 140ms ease, background 140ms ease, box-shadow 140ms ease;
            font-family: inherit;
            font-size: 0.9rem;
        }
        .btn:hover { 
            transform: translateY(-2px); 
            background: var(--admin-accent); 
            color: var(--admin-text);
            box-shadow: 0 6px 14px rgba(11,22,33,0.04); 
        }
        .btn-primary {
            background: var(--admin-text);
            border: none;
            color: var(--admin-card);
            font-weight: 700;
        }
        .btn-danger {
            background: linear-gradient(180deg, #ff8a8a, var(--danger));
            border: none;
            color: #fff;
        }
        .btn-secondary {
            background: var(--admin-card);
            border: 1px solid var(--muted-border);
            color: var(--admin-text);
        }
        .adminexit{
            box-shadow: 0 4px 8px -2px rgba(0,0,0,0.2);
            background: linear-gradient(180deg, #ff8a8a, var(--danger));
            color: white;
        }
        .exportdues{
            box-shadow: 0 4px 8px -2px rgba(0,0,0,0.2);
        }

        /* Form controls (light) */
        .search-box, select, input[type="text"] {
            background: var(--admin-card);
            border: 1px solid var(--muted-border);
            color: var(--admin-text);
            padding: 0.5rem 0.6rem;
            border-radius: 8px;
            min-width: 220px;
            box-shadow: 0 3px 8px rgba(16,24,40,0.02) inset;
            font-family: inherit;
            font-size: 0.9rem;
        }

        /* Admin controls */
        .admin-controls {
            margin-bottom: 1rem;
        }

        .search-section {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Small utilities */
        .actions-container { 
            display:flex; 
            gap:0.6rem; 
            flex-wrap:wrap; 
        }
        .dues-marking-section { 
            display:flex; 
            gap:0.6rem; 
            align-items:center; 
            flex-wrap:wrap; 
        }
        .form-group { 
            display: flex;
            flex-direction: column;
        }
        .form-group label { 
            display:block; 
            font-size:0.85rem; 
            color:var(--admin-muted); 
            margin-bottom:0.25rem; 
        }

        /* Footer responsive */
        .footer {
            margin-top: 2rem;
            padding: 1rem;
            color: var(--admin-muted);
            border-top: 1px solid var(--muted-border);
            background: var(--admin-card);
            width: 100%;
            box-sizing: border-box;
            text-align: center;
        }

        .footer-content {
            max-width: 1120px;
            margin: 0 auto;
            display:flex;
            align-items:center;
            text-align: center;
            justify-content:space-between;
            gap:1rem;
            padding: 0 0.25rem;
            box-sizing: border-box;
            place-content: center;  
            flex-wrap: wrap;
        }

        .footer-content p { 
            margin: 0;
        }

        /* Responsive specifics */
        @media (max-width: 768px) {
            .menu-toggle { 
                display: inline-block; 
            }

            /* Make logo row full width and push nav buttons below when collapsed */
            .logo-section {
                width: 100%;
                justify-content: space-between;
            }

            /* nav buttons collapse below the logo row and expand full width when opened */
            .nav-buttons {
                width: 100%;
                display: none; /* hidden by default on mobile */
                justify-content: center;
                margin-top: 0.6rem;
                gap: 0.5rem;
                padding-bottom: 0.4rem;
                box-sizing: border-box;
            }

            .nav-buttons.open {
                display: flex;
                flex-wrap: wrap;
            }

            /* Dashboard adjustments */
            .dashboard-container {
                padding: 1rem;
                margin: 1rem auto;
            }

            .dashboard-header h1 {
                font-size: 1.4rem;
            }

            /* Form controls */
            .search-box, select, input[type="text"] {
                min-width: 0;
                width: 100%;
            }

            .search-section {
                flex-direction: column;
                align-items: stretch;
            }

            /* Stats cards */
            .admin-stats { 
                flex-direction: column; 
            }
            .stat-card { 
                width: 100%; 
            }

            /* Table adjustments */
            .members-table { 
                min-width: 0; 
                font-size: 0.85rem;
            }
            
            .members-table thead th,
            .members-table tbody td {
                padding: 0.6rem 0.4rem;
            }

            /* Dues marking section */
            .dues-marking-section {
                flex-direction: column;
                align-items: stretch;
            }

            /* Footer adjustments */
            .footer {
                padding: 0.9rem;
            }
            .footer-content {
                flex-direction: column;
                align-items: center;
                gap: 0.4rem;
                text-align: center;
            }

            /* Button adjustments */
            .btn {
                width: 100%;
                text-align: center;
            }

            .actions-container {
                flex-direction: column;
            }
        }

        /* Medium screens */
        @media (min-width: 769px) and (max-width: 1024px) {
            .dashboard-container {
                padding: 1.2rem;
            }
            
            .members-table {
                min-width: 600px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="logo-section">
                <a href="index.html" style="text-decoration: none; display: flex; align-items: center; gap: 1rem; min-width:0;">
                    <img src="images/logo.png" alt="KSJi Logo" class="logo">
                    <span class="site-name">KSJI Cadet Portal</span>
                </a>

                <!-- mobile menu toggle -->
                <button class="menu-toggle" aria-label="Toggle menu" onclick="toggleMenu()">☰</button>
            </div>

            <div class="nav-buttons" id="navButtons">
                <button class="btn btn-secondary adminexit" onclick="handleLogout()">Exit Admin</button>
            </div>
        </div>
    </nav>

    <main class="dashboard-container">
        <div class="dashboard-header">
            <h1>Admin Dashboard</h1>
            <p id="adminWelcome">Manage members and track dues payments</p>
        </div>

        <!-- Added dedicated section for marking dues payments with clear UX -->
        <div class="dashboard-card">
            <h3>Mark Dues as Paid</h3>
            <div class="dues-marking-section">
                <div class="form-group">
                    <label for="duesMemberSelect">Select Member:</label>
                    <select id="duesMemberSelect" class="search-box">
                        <option value="">Choose a member...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="duesMonthSelect">Select Month:</label>
                    <select id="duesMonthSelect" class="search-box">
                        <option value="">Choose a month...</option>
                        <option value="1-2025">January 2025</option>
                        <option value="2-2025">February 2025</option>
                        <option value="3-2025">March 2025</option>
                        <option value="4-2025">April 2025</option>
                        <option value="5-2025">May 2025</option>
                        <option value="6-2025">June 2025</option>
                        <option value="7-2025">July 2025</option>
                        <option value="8-2025">August 2025</option>
                        <option value="9-2025">September 2025</option>
                        <option value="10-2025">October 2025</option>
                        <option value="11-2025">November 2025</option>
                        <option value="12-2025">December 2025</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="markSelectedMemberPaid()">Mark as Paid</button>
            </div>
        </div>

        <div class="admin-controls">
            <div class="search-section">
                <input type="text" id="searchInput" placeholder="Search by member name or ID..." class="search-box">
                <button class="btn btn-secondary" onclick="performSearch()">Search</button>
            </div>
        </div>

        <div class="admin-stats">
            <div class="stat-card">
                <h4>Total Members</h4>
                <p id="totalMembers" class="stat-number">0</p>
            </div>
            <div class="stat-card">
                <h4>Total Dues Collected</h4>
                <p id="totalDues" class="stat-number">0</p>
            </div>
        </div>

        <div class="dashboard-card full-width">
            <h3>Member Management</h3>
            <div class="table-container">
                <table class="members-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Cadet ID</th>
                            <th>Email</th>
                            <th>Months Paid</th>
                            <th>Paid Months</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem;">Loading members...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-card full-width">
            <h3>Quick Actions</h3>
            <div class="actions-container">
                <button class="btn btn-secondary exportdues" onclick="exportToCSV()">Export Dues Records</button>
                <button class="btn btn-secondary" onclick="toggleDarkMode()">Toggle Dark Mode</button>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 KSJI Cadet Group. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/auth.js"></script>
    <script>
        // mobile menu toggle
        function toggleMenu() {
            const nav = document.getElementById('navButtons');
            if (!nav) return;
            nav.classList.toggle('open');
        }

        let allMembers = [];

        document.addEventListener('DOMContentLoaded', function() {
            const user = getLoggedInUser();
            if (!user || !user.isAdminSession) {
                window.location.href = 'index.html';
                return;
            }

            loadMembers();
            updateStats();
            populateMemberSelect();
            
            // Add event listener for Enter key in search
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        });

        function loadMembers(searchTerm = '') {
            const users = getUsersFromStorage();
            allMembers = users.filter(u => u.role === 'member');
            
            let filteredMembers = allMembers;
            if (searchTerm) {
                filteredMembers = allMembers.filter(m => 
                    m.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    m.id.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            const tableBody = document.getElementById('membersTableBody');
            if (filteredMembers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No members found</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            filteredMembers.forEach(member => {
                const row = document.createElement('tr');
                const paidMonths = member.duesPaid && member.duesPaid.length > 0 
                    ? member.duesPaid.map(m => m.split('-')[0]).join(', ')
                    : 'None';
                
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>${member.id}</td>
                    <td>${member.email}</td>
                    <td>${member.duesPaid ? member.duesPaid.length : 0}</td>
                    <td style="font-size: 0.9rem; color: var(--admin-muted);">Month(s): ${paidMonths}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteMember('${member.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value;
            loadMembers(searchTerm);
        }

        function deleteMember(memberId) {
            if (confirm('Are you sure you want to delete this member? This action cannot be undone.')) {
                const users = getUsersFromStorage();
                const filteredUsers = users.filter(u => u.id !== memberId);
                saveUsersToStorage(filteredUsers);
                loadMembers();
                updateStats();
                populateMemberSelect();
            }
        }

        function updateStats() {
            const users = getUsersFromStorage();
            const members = users.filter(u => u.role === 'member');
            const totalDuesPayments = members.reduce((sum, m) => sum + (m.duesPaid ? m.duesPaid.length : 0), 0);

            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('totalDues').textContent = totalDuesPayments + ' months';
        }

        function exportToCSV() {
            const users = getUsersFromStorage();
            const members = users.filter(u => u.role === 'member');

            let csvContent = 'data:text/csv;charset=utf-8,';
            csvContent += 'Name,Cadet ID,Email,Months Paid,Paid Months\n';

            members.forEach(member => {
                const paidMonths = member.duesPaid && member.duesPaid.length > 0 
                    ? member.duesPaid.join('; ')
                    : 'None';
                csvContent += `"${member.name}","${member.id}","${member.email}",${member.duesPaid ? member.duesPaid.length : 0},"${paidMonths}"\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `ksji_dues_records_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        function handleLogout() {
            logoutUser();
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        function populateMemberSelect() {
            const users = getUsersFromStorage();
            const members = users.filter(u => u.role === 'member');
            const memberSelect = document.getElementById('duesMemberSelect');
            
            memberSelect.innerHTML = '<option value="">Choose a member...</option>';
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (${member.id})`;
                memberSelect.appendChild(option);
            });
        }

        function markSelectedMemberPaid() {
            const memberId = document.getElementById('duesMemberSelect').value;
            const selectedMonth = document.getElementById('duesMonthSelect').value;
            
            console.log('[v0] Mark Paid clicked - Member:', memberId, 'Month:', selectedMonth);
            
            if (!memberId) {
                alert('Please select a member');
                return;
            }
            
            if (!selectedMonth) {
                alert('Please select a month');
                return;
            }

            const result = updateMemberDuesPaid(memberId, selectedMonth);
            console.log('[v0] Update result:', result);
            
            if (result.success) {
                const memberName = result.user.name;
                const monthName = document.querySelector(`option[value="${selectedMonth}"]`).textContent;
                alert(`✓ Dues marked as paid for ${memberName} - ${monthName}`);
                loadMembers();
                updateStats();
                populateMemberSelect();
                document.getElementById('duesMemberSelect').value = '';
                document.getElementById('duesMonthSelect').value = '';
            } else {
                alert('Error: ' + result.message);
            }
        }
    </script>
</body>
</html>